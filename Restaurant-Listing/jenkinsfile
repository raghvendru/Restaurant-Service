pipeline {
  agent any

  environment {
    DOCKERHUB_CREDENTIALS = credentials('DOCKER_HUB_CREDENTIALS')
    VERSION = "${env.BUILD_ID}"

  }

  tools {
    maven "Maven"
  }

  stages {

    stage('Maven Build'){
         steps {
                dir('Restaurant-Listing') {
                 sh 'mvn clean package -DskipTests'
                      }
                }
    }

     stage('Run Tests') {
                 steps {
                     dir('Restaurant-Listing') {
                         sh 'mvn test'
                     }
                 }
             }

    stage('SonarQube Analysis') {
  steps {
  dir('Restaurant-Listing') {
    sh 'mvn clean org.jacoco:jacoco-maven-plugin:prepare-agent install sonar:sonar -Dsonar.host.url=http://15.237.253.27:9000/ -Dsonar.login=squ_cb46075e6c73822a511d21817fbcc767ca47bf5b'
  }
}
}


   stage('Check code coverage') {
            steps {
                script {
                    def token = "squ_cb46075e6c73822a511d21817fbcc767ca47bf5b"
                    def sonarQubeUrl = "http://15.237.253.27:9000/api"
                    def componentKey = "com.jagcoder:Restaurant-Listing"
                    def coverageThreshold = 55.0

                    def response = sh (
                        script: "curl -H 'Authorization: Bearer ${token}' '${sonarQubeUrl}/measures/component?component=${componentKey}&metricKeys=coverage'",
                        returnStdout: true
                    ).trim()

                    def coverage = sh (
                        script: "echo '${response}' | jq -r '.component.measures[0].value'",
                        returnStdout: true
                    ).trim().toDouble()

                    echo "Coverage: ${coverage}"

                    if (coverage < coverageThreshold) {
                        error "Coverage is below the threshold of ${coverageThreshold}%. Aborting the pipeline."
                    }
                }
            }
        }


      stage('Docker Build and Push') {
                 steps {
                     withCredentials([usernamePassword(credentialsId: 'DOCKER_HUB_CREDENTIALS', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                         sh 'echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin'

                         dir('Restaurant-Listing') {
                             sh 'docker build -t raghuuppar/restaurant-listing-server:${VERSION} .'
                             sh 'docker push raghuuppar/restaurant-listing-server:${VERSION}'
                         }
                     }
                 }
             }


     stage('Cleanup Workspace') {
      steps {
        deleteDir()

      }
    }



  stage('Update Image Tag in GitOps') {
      steps {
          withCredentials([sshUserPrivateKey(credentialsId: 'git-ssh', keyFileVariable: 'SSH_KEY')]) {
              sh '''
                  # Create SSH directory and set permissions
                  mkdir -p ~/.ssh
                  chmod 700 ~/.ssh

                  # Copy SSH key to a temporary file with correct permissions
                  cp "${SSH_KEY}" ~/.ssh/id_rsa
                  chmod 600 ~/.ssh/id_rsa

                  # Add GitHub to known hosts
                  ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts
                  chmod 644 ~/.ssh/known_hosts

                  # Configure Git
                  git config --global user.email "raghavendruppar@gmail.com"
                  git config --global user.name "raghavendru"

                  # Use GIT_SSH_COMMAND to specify the key
                  export GIT_SSH_COMMAND="ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no"

                  # Clone and update repository
                  git clone git@github.com:raghavendruppar/Restaurant-Service.git
                  cd Restaurant-Service

                  sed -i "s|image:.*|image: raghuuppar/restaurant-listing-server:${VERSION}|" deployment-folder/aws/restaurant-manifest.yml

                  git add deployment-folder/aws/restaurant-manifest.yml
                  git commit -m "Update image tag for version ${VERSION}"
                  git push origin main

                  # Cleanup
                  rm -f ~/.ssh/id_rsa
              '''
          }
      }
  }
  }

  }

